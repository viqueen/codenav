#!/usr/bin/env bash

_with_arguments() {
    count=${1}
    shift
    if [[ "$#" -lt ${count} ]]; then
        echo "missing arguments, expected at least ${count} but received $#"
        exit 1
    fi
}

function register() {
    _with_arguments 1 "$@"
    username=${1}; shift

    # TODO : handle pagination
    items=(
        $(
            curl -s -X GET https://api.bitbucket.org/2.0/repositories/${username} \
                | jq -r '.values[].links.clone[]|select(.name=="ssh")|.href'
        )
    )

    for item in "${items[@]}";
    do
        cnav register "${item}"
    done
}

eval $@